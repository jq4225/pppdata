---
title: "10_bankbybank"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(broom)
library(estimatr)
library(texreg)
#library(readxl)
```

```{r}
# Load up the data for most recent stuff, as usual

most_recent <- readRDS('most_recent_zip.rds')

most_recent_county <- readRDS('most_recent_county.rds')

baml <- most_recent %>%
  mutate(baml = ifelse(lender == "bank of america, national association",
                       1, 0))
```


```{r}
# Zip code level -- let's look at some banks

# bank_ppp_policy_manual <- 
#   read_excel('raw_data/bank_ppp_policy_manual.xlsx', sheet = "Sheet2") %>%
#   
#   # We do some minor cleaning of the business names, like by trimming
#   # and converting to common case.
#   
#   mutate(sba_name = tolower(sba_name)) %>%
#   mutate(sba_name = str_trim(sba_name, side = "both")) %>%
#   drop_na(preference, requirement)
```


```{r}
# Let's see if we can make the indicators all at once -- this uses the 
# ade4 package as here: https://stackoverflow.com/questions/5048638/automatically-expanding-an-r-factor-into-a-collection-of-1-0-indicator-variables

current_bankindicators <- most_recent %>%
  select(lender)

indicators <- acm.disjonctif(current_bankindicators)
```

```{r}


```

```{r}
baml_reg <- lm_robust(
       business_days ~ 1 + 
    median_family_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    cook_pvi + 
    rural +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    payroll +
    unemployment_rate_apr + 
    unemployment_rate + 
    mean_start_cases_weighted +
    mean_start_deaths_weighted + 
    mean_end_cases_weighted +
    mean_end_deaths_weighted + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       baml + I(baml * minority_percent) + 
       I(baml * median_family_income) +
       I(baml * unemployment_rate), baml, clusters = zip, se_type = "CR0")

summary(baml_reg )
```


```{r}
jpm <- most_recent %>%
  mutate(jpm = ifelse(lender == "jpmorgan chase bank, national association",
                       1, 0))
```


```{r}
jpm_reg <- lm_robust(
       business_days ~ 1 + 
    median_family_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    cook_pvi + 
    rural +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    payroll +
    unemployment_rate_apr + 
    unemployment_rate + 
    mean_start_cases_weighted +
    mean_start_deaths_weighted + 
    mean_end_cases_weighted +
    mean_end_deaths_weighted + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       jpm + I(jpm * minority_percent) + 
       I(jpm * median_family_income) +
       I(jpm * unemployment_rate), jpm, clusters = zip, se_type = "CR0")

summary(jpm_reg )
```


```{r}
citi <- most_recent %>%
  mutate(citi = ifelse(lender == "citibank, n.a.",
                       1, 0))

citi_reg <- lm_robust(
       business_days ~ 1 + 
    median_family_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    cook_pvi + 
    rural +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    payroll +
    unemployment_rate_apr + 
    unemployment_rate + 
    mean_start_cases_weighted +
    mean_start_deaths_weighted + 
    mean_end_cases_weighted +
    mean_end_deaths_weighted + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       citi + I(citi * minority_percent) + 
       I(citi * median_family_income) +
       I(citi * unemployment_rate), citi, clusters = zip, se_type = "CR0")

summary(citi_reg )
```


```{r}
wells <- most_recent %>%
  mutate(wells = ifelse(lender == "wells fargo bank, national association",
                       1, 0))

wells_reg <- lm_robust(
       business_days ~ 1 + 
    median_family_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    cook_pvi + 
    rural +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    payroll +
    unemployment_rate_apr + 
    unemployment_rate + 
    mean_start_cases_weighted +
    mean_start_deaths_weighted + 
    mean_end_cases_weighted +
    mean_end_deaths_weighted + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       wells + I(wells * minority_percent) + 
       I(wells * median_family_income) +
       I(wells * unemployment_rate), wells, clusters = zip, se_type = "CR0")

summary(wells_reg )
```


```{r}
# Dummy coding for wells fargo
credit_union <- most_recent %>%
    mutate(cu = 0) %>%
    mutate(cu = ifelse(str_detect(lender, pattern = "\\sfcu$"), 1, 
                              cu),
         cu = ifelse(str_detect(lender, pattern = "\\scu$"), 1, 
                              cu),
         cu = ifelse(str_detect(lender, pattern = "credit union"), 1, 
                              cu))

credit_union_reg <- lm_robust(business_days ~ 1 + 
    median_family_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    cook_pvi + 
    rural +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    payroll +
    unemployment_rate_apr + 
    unemployment_rate + 
    mean_start_cases_weighted +
    mean_start_deaths_weighted + 
    mean_end_cases_weighted +
    mean_end_deaths_weighted + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       cu + I(cu * minority_percent) + 
       I(cu * median_family_income) +
       I(cu * unemployment_rate), credit_union, clusters = zip, se_type = "CR0")

summary(credit_union_reg )
```


```{r}
# COUNTIES indicator variables

banks_county <- most_recent_county %>%
  mutate(baml = ifelse(lender == "bank of america, national association",
                       1, 0)) %>%
  mutate(jpm = ifelse(lender == "jpmorgan chase bank, national association",
                       1, 0)) %>%
  mutate(citi = ifelse(lender == "citibank, n.a.",
                       1, 0)) %>%
  mutate(wells = ifelse(lender == "wells fargo bank, national association",
                       1, 0)) %>%
    mutate(cu = 0) %>%
    mutate(cu = ifelse(str_detect(lender, pattern = "\\sfcu$"), 1, 
                              cu),
         cu = ifelse(str_detect(lender, pattern = "\\scu$"), 1, 
                              cu),
         cu = ifelse(str_detect(lender, pattern = "credit union"), 1, 
                              cu))
```


```{r}

baml_reg_county <- lm_robust(
       business_days ~ 1 + 
    median_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    republican_percent + 
    pop_den +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    gdp +
    unemployment_rate_apr + 
    unemployment_rate_percent + 
    mean_start_cases +
    mean_start_deaths + 
    mean_end_cases +
    mean_end_deaths + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       baml + I(baml * minority_percent) + 
       I(baml * median_income) +
       I(baml * unemployment_rate_percent), banks_county, 
    clusters = fips, se_type = "CR0")


citi_reg_county <- lm_robust(
       business_days ~ 1 + 
    median_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    republican_percent + 
    pop_den +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    gdp +
    unemployment_rate_apr + 
    unemployment_rate_percent + 
    mean_start_cases +
    mean_start_deaths + 
    mean_end_cases +
    mean_end_deaths + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       citi + I(citi * minority_percent) + 
       I(citi * median_income) +
       I(citi * unemployment_rate_percent), banks_county, 
    clusters = fips, se_type = "CR0")

jpm_reg_county <- lm_robust(
       business_days ~ 1 + 
    median_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    republican_percent + 
    pop_den +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    gdp +
    unemployment_rate_apr + 
    unemployment_rate_percent + 
    mean_start_cases +
    mean_start_deaths + 
    mean_end_cases +
    mean_end_deaths + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       jpm + I(jpm * minority_percent) + 
       I(jpm * median_income) +
       I(jpm * unemployment_rate_percent), 
    banks_county, clusters = fips, se_type = "CR0")

wells_reg_county <- lm_robust(
       business_days ~ 1 + 
    median_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    republican_percent + 
    pop_den +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    gdp +
    unemployment_rate_apr + 
    unemployment_rate_percent + 
    mean_start_cases +
    mean_start_deaths + 
    mean_end_cases +
    mean_end_deaths + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       wells + I(wells * minority_percent) + 
       I(wells * median_income) +
       I(wells * unemployment_rate_percent), banks_county, 
    clusters = fips, se_type = "CR0")

credit_union_reg <- lm_robust(business_days ~ 1 + 
    median_income + 
    minority_percent +
    high_school_pct + 
    married_percent + 
    republican_percent + 
    pop_den +
    estimate_gini_index +
    violent_crime_rate + 
    delay +
    loan_150_350 +
    loan_350_1mil +
    loan_1mil_2mil +
    loan_2mil_5mil + 
    loan_5mil_10mil + 
    preference + 
    requirement + 
    bank_ppp_issued + 
    jobs_reported +
    banks_per_pop + 
    businesses_per_pop + 
    gdp +
    unemployment_rate_apr + 
    unemployment_rate_percent + 
    mean_start_cases +
    mean_start_deaths + 
    mean_end_cases +
    mean_end_deaths + 
    stay_at_home_apr + 
    stay_at_home_current + 
    non_essential_closure_apr + 
    non_essential_closure_current + 
       cu + I(cu * minority_percent) + 
       I(cu * median_income) +
       I(cu * unemployment_rate_percent), 
    banks_county, clusters = fips, se_type = "CR0")
```

