---
title: "10_bankbybank"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(broom)
library(estimatr)
library(ade4)
#library(readxl)
```

```{r}
# Load up the data for most recent stuff, as usual

most_recent <- readRDS('ppp_allvars_1028.rds') %>%
  mutate(median_family_income = median_family_income / 1000,
         bank_ppp_issued = bank_ppp_issued / 1000,
         businesses_per_pop = businesses_per_pop / 100,
         violent_crime_rate = violent_crime_rate / 10,
         lender = as.factor(lender))

most_recent_county <- readRDS('counties_all_1028.rds') %>%
   mutate(median_income = median_income / 1000,
         bank_ppp_issued = bank_ppp_issued / 1000,
         
         # This is b/c we didn't do per 10,000 people before, but we want 
         # hundreds of businesses 
         # per 10,000 people, or 100
         
         businesses_per_pop = businesses_per_pop * 100,
         violent_crime_rate = violent_crime_rate / 10,
         pop_den = pop_den / 100,
         black_percent = black_percent * 100,
         white_percent = white_percent * 100)

baml <- most_recent %>%
  mutate(baml = ifelse(lender == "bank of america, national association",
                       1, 0))
```


```{r}
# Zip code level -- let's look at some banks

# bank_ppp_policy_manual <- 
#   read_excel('raw_data/bank_ppp_policy_manual.xlsx', sheet = "Sheet2") %>%
#   
#   # We do some minor cleaning of the business names, like by trimming
#   # and converting to common case.
#   
#   mutate(sba_name = tolower(sba_name)) %>%
#   mutate(sba_name = str_trim(sba_name, side = "both")) %>%
#   drop_na(preference, requirement)
```


```{r}
# Let's see if we can make the indicators all at once -- this uses the 
# ade4 package as here: https://stackoverflow.com/questions/5048638/automatically-expanding-an-r-factor-into-a-collection-of-1-0-indicator-variables

current_bankindicators <- most_recent %>%
  select(lender)

indicators <- acm.disjonctif(current_bankindicators)
```


```{r}
all_linear_reg <- lm_robust(days_to_approval ~ 1 + median_family_income +
       black_percent +
       white_percent +
       high_school_pct +
       banks_per_pop + 
       loan_350_1mil + loan_150_350 + 
       loan_5mil_10mil +
       loan_2mil_5mil + loan_1mil_2mil +
       cook_pvi + mean_start_cases_weighted + 
       mean_start_deaths_weighted + mean_end_cases_weighted +
       mean_end_deaths_weighted + 
       bank_ppp_issued +
       rural + businesses_per_pop +
       married_percent + preference +
       requirement + 
       stay_at_home_apr +
       stay_at_home_current +
       non_essential_closure_apr +
       non_essential_closure_current + 
       unemployment_rate + 
       unemployment_rate_apr + 
       estimate_gini_index +
       violent_crime_rate +
       jobs_reported + 
       I(cook_pvi * black_percent), most_recent, clusters = zip, se_type = "CR0")

summary(all_linear_reg)

tibble_all_linear <- tidy(all_linear_reg)

```

